FROM node:16.16.0-alpine

ARG NEXTAUTH_SECRET
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ARG GITHUB_CLIENT_ID
ENV GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
ARG GITHUB_CLIENT_SECRET
ENV GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
ARG GITHUB_ACCESS_TOKEN
ENV GITHUB_ACCESS_TOKEN=${GITHUB_ACCESS_TOKEN}
ARG DATABASE_URL
ENV DATABASE_URL=${DATABASE_URL}
ARG SMTP_FROM
ENV SMTP_FROM=${SMTP_FROM}
ARG POSTMARK_API_TOKEN
ENV POSTMARK_API_TOKEN=${POSTMARK_API_TOKEN}
ARG POSTMARK_SIGN_IN_TEMPLATE
ENV POSTMARK_SIGN_IN_TEMPLATE=${POSTMARK_SIGN_IN_TEMPLATE}
ARG POSTMARK_ACTIVATION_TEMPLATE
ENV POSTMARK_ACTIVATION_TEMPLATE=${POSTMARK_ACTIVATION_TEMPLATE}
ARG STRIPE_API_KEY
ENV STRIPE_API_KEY=${STRIPE_API_KEY}
ARG STRIPE_WEBHOOK_SECRET
ENV STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
ARG STRIPE_PRO_MONTHLY_PLAN_ID
ENV STRIPE_PRO_MONTHLY_PLAN_ID=${STRIPE_PRO_MONTHLY_PLAN_ID}
ARG NEXT_PUBLIC_APP_URL
ENV NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}

# create destination directory
RUN mkdir -p /usr/src/admin
WORKDIR /usr/src/admin

# install app dependencies
COPY package.json ./
# COPY package-lock.json ./
RUN npm install -g pnpm
RUN pnpm install

# Copying all the files in our project
COPY . .

RUN NODE_OPTIONS=--max_old_space_size=1024 npm run build

EXPOSE 3000

# start app
CMD [ "npm", "start" ]